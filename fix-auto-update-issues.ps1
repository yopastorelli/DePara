# Script PowerShell para corrigir problemas da atualiza√ß√£o autom√°tica
# - Corrigir verifica√ß√£o de status ap√≥s atualiza√ß√£o
# - Melhorar sequ√™ncia de reinicializa√ß√£o
# - Corrigir links quebrados

Write-Host "üîß Corrigindo problemas da atualiza√ß√£o autom√°tica..." -ForegroundColor Blue

# 1. Parar DePara se estiver rodando
Write-Host "‚èπÔ∏è Parando DePara..." -ForegroundColor Yellow

$nodeProcesses = Get-Process -Name "node" -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*main.js*" }
if ($nodeProcesses) {
    Stop-Process -Id $nodeProcesses.Id -Force
    Start-Sleep -Seconds 3
    Write-Host "‚úÖ DePara parado" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è DePara n√£o estava rodando" -ForegroundColor Yellow
}

# 2. Navegar para o diret√≥rio
Set-Location $PSScriptRoot

# 3. Fazer backup das mudan√ßas locais
Write-Host "üíæ Fazendo backup das mudan√ßas locais..." -ForegroundColor Yellow
git stash push -m "Backup antes da corre√ß√£o de atualiza√ß√£o autom√°tica" 2>$null

# 4. Atualizar reposit√≥rio
Write-Host "üì• Atualizando reposit√≥rio..." -ForegroundColor Yellow
git fetch origin
git pull origin main

# 5. Reinstalar depend√™ncias
Write-Host "üì¶ Reinstalando depend√™ncias..." -ForegroundColor Yellow
npm install

# 6. Corrigir problema de verifica√ß√£o de status
Write-Host "üîß Corrigindo verifica√ß√£o de status..." -ForegroundColor Yellow

# Criar script melhorado para verifica√ß√£o de status
$checkScript = @"
# Script melhorado para verificar status de atualiza√ß√µes
cd "`$PSScriptRoot"

# Fazer fetch para garantir que temos as √∫ltimas informa√ß√µes
git fetch origin > `$null 2>&1

# Verificar se h√° commits √† frente
`$commitsAhead = 0
try {
    `$commitsAhead = [int](git rev-list HEAD..origin/main --count 2>`$null)
} catch {
    `$commitsAhead = 0
}

# Verificar se h√° commits atr√°s (local desatualizado)
`$commitsBehind = 0
try {
    `$commitsBehind = [int](git rev-list origin/main..HEAD --count 2>`$null)
} catch {
    `$commitsBehind = 0
}

# Determinar status
if (`$commitsAhead -gt 0) {
    Write-Host "HAS_UPDATES=true"
    Write-Host "COMMITS_AHEAD=`$commitsAhead"
} elseif (`$commitsBehind -gt 0) {
    Write-Host "HAS_UPDATES=false"
    Write-Host "COMMITS_AHEAD=0"
    Write-Host "LOCAL_AHEAD=true"
} else {
    Write-Host "HAS_UPDATES=false"
    Write-Host "COMMITS_AHEAD=0"
    Write-Host "UP_TO_DATE=true"
}

# Obter vers√£o atual
try {
    `$currentVersion = git rev-parse --short HEAD 2>`$null
    if (`$currentVersion) {
        Write-Host "CURRENT_VERSION=`$currentVersion"
    } else {
        Write-Host "CURRENT_VERSION=unknown"
    }
} catch {
    Write-Host "CURRENT_VERSION=unknown"
}
"@

$checkScript | Out-File -FilePath "check-update-status.ps1" -Encoding UTF8

# 7. Corrigir rota de verifica√ß√£o de atualiza√ß√µes
Write-Host "üîß Corrigindo rota de verifica√ß√£o..." -ForegroundColor Yellow

# Fazer backup do arquivo original
Copy-Item "src/routes/update.js" "src/routes/update.js.backup"

# Atualizar a rota para usar o script melhorado
$updateRoute = @'
/**
 * Rotas para Sistema de Atualiza√ß√£o Autom√°tica
 * 
 * @author yopastorelli
 * @version 1.0.0
 */

const express = require('express');
const { exec } = require('child_process');
const router = express.Router();
const logger = require('../utils/logger');

/**
 * Verificar atualiza√ß√µes dispon√≠veis
 * GET /api/update/check
 */
router.get('/check', async (req, res) => {
    try {
        logger.info('üîç Verificando atualiza√ß√µes...');

        // Usar script melhorado para verifica√ß√£o
        const isWindows = process.platform === 'win32';
        const checkCommand = isWindows ? 'powershell -ExecutionPolicy Bypass -File check-update-status.ps1' : './check-update-status.sh';
        
        exec(checkCommand, (error, stdout, stderr) => {
            if (error) {
                logger.warn('‚ö†Ô∏è Erro ao verificar atualiza√ß√µes:', error.message);
                return res.status(500).json({
                    success: false,
                    error: {
                        message: 'Erro ao verificar atualiza√ß√µes',
                        details: error.message
                    }
                });
            }

            // Parse do output do script
            const lines = stdout.trim().split('\n');
            let hasUpdates = false;
            let commitsAhead = 0;
            let currentVersion = 'unknown';

            lines.forEach(line => {
                if (line.startsWith('HAS_UPDATES=')) {
                    hasUpdates = line.split('=')[1] === 'true';
                } else if (line.startsWith('COMMITS_AHEAD=')) {
                    commitsAhead = parseInt(line.split('=')[1]) || 0;
                } else if (line.startsWith('CURRENT_VERSION=')) {
                    currentVersion = line.split('=')[1];
                }
            });

            logger.info(`üìä Status: ${commitsAhead} commits √† frente, vers√£o: ${currentVersion}`);

            res.status(200).json({
                success: true,
                data: {
                    hasUpdates,
                    commitsAhead,
                    currentVersion,
                    lastChecked: new Date().toISOString(),
                    message: hasUpdates ? 
                        `H√° ${commitsAhead} atualiza√ß√£o(√µes) dispon√≠vel(is)` : 
                        'DePara est√° atualizado'
                },
                timestamp: new Date().toISOString()
            });
        });

    } catch (error) {
        logger.operationError('Update Check', error);
        res.status(500).json({
            success: false,
            error: {
                message: 'Erro interno ao verificar atualiza√ß√µes',
                details: error.message
            }
        });
    }
});

/**
 * Aplicar atualiza√ß√µes
 * POST /api/update/apply
 */
router.post('/apply', async (req, res) => {
    try {
        logger.info('üîÑ Aplicando atualiza√ß√µes...');

        // Fazer backup das mudan√ßas locais
        exec('git stash push -m "Backup antes da atualiza√ß√£o autom√°tica"', (error, stdout, stderr) => {
            if (error) {
                logger.warn('‚ö†Ô∏è Erro ao fazer backup:', error.message);
            }

            // Fazer pull das atualiza√ß√µes
            exec('git pull origin main', (error, stdout, stderr) => {
                if (error) {
                    logger.error('‚ùå Erro ao aplicar atualiza√ß√µes:', error.message);
                    return res.status(500).json({
                        success: false,
                        error: {
                            message: 'Erro ao aplicar atualiza√ß√µes',
                            details: error.message
                        }
                    });
                }

                logger.info('‚úÖ Atualiza√ß√µes aplicadas com sucesso');

                // Reinstalar depend√™ncias se necess√°rio
                exec('npm install', (error, stdout, stderr) => {
                    if (error) {
                        logger.warn('‚ö†Ô∏è Erro ao reinstalar depend√™ncias:', error.message);
                    }

                    res.status(200).json({
                        success: true,
                        message: 'Atualiza√ß√µes aplicadas com sucesso',
                        data: {
                            output: stdout,
                            timestamp: new Date().toISOString()
                        }
                    });
                });
            });
        });

    } catch (error) {
        logger.operationError('Update Apply', error);
        res.status(500).json({
            success: false,
            error: {
                message: 'Erro interno ao aplicar atualiza√ß√µes',
                details: error.message
            }
        });
    }
});

/**
 * Reiniciar aplica√ß√£o ap√≥s atualiza√ß√£o
 * POST /api/update/restart
 */
router.post('/restart', async (req, res) => {
    try {
        logger.info('üîÑ Reiniciando aplica√ß√£o ap√≥s atualiza√ß√£o...');

        // Parar DePara atual (compat√≠vel com Windows e Linux)
        const isWindows = process.platform === 'win32';
        const stopCommand = isWindows ? 'taskkill /F /IM node.exe' : 'pkill -f "node.*main.js"';
        
        exec(stopCommand, (error, stdout, stderr) => {
            if (error) {
                logger.warn('‚ö†Ô∏è Erro ao parar DePara:', error.message);
            }

            // Aguardar um pouco
            setTimeout(() => {
                // Iniciar DePara novamente (compat√≠vel com Windows e Linux)
                const startCommand = isWindows ? 'npm start' : 'nohup npm start > /dev/null 2>&1 &';
                
                exec(startCommand, (error, stdout, stderr) => {
                    if (error) {
                        logger.error('‚ùå Erro ao reiniciar DePara:', error.message);
                        return res.status(500).json({
                            success: false,
                            error: {
                                message: 'Erro ao reiniciar aplica√ß√£o',
                                details: error.message
                            }
                        });
                    }

                    logger.info('‚úÖ Aplica√ß√£o reiniciada com sucesso');

                    res.status(200).json({
                        success: true,
                        message: 'Aplica√ß√£o reiniciada com sucesso',
                        timestamp: new Date().toISOString()
                    });
                });
            }, 2000);
        });

    } catch (error) {
        logger.operationError('Update Restart', error);
        res.status(500).json({
            success: false,
            error: {
                message: 'Erro interno ao reiniciar aplica√ß√£o',
                details: error.message
            }
        });
    }
});

/**
 * Obter status da aplica√ß√£o
 * GET /api/update/status
 */
router.get('/status', async (req, res) => {
    try {
        logger.info('üìä Verificando status da aplica√ß√£o...');

        // Verificar se DePara est√° rodando (compat√≠vel com Windows e Linux)
        const isWindows = process.platform === 'win32';
        const checkCommand = isWindows ? 'tasklist /FI "IMAGENAME eq node.exe"' : 'pgrep -f "node.*main.js"';
        
        exec(checkCommand, (error, stdout, stderr) => {
            const isRunning = !error && stdout.trim() !== '';
            
            // Obter vers√£o atual
            exec('git rev-parse --short HEAD', (error, stdout, stderr) => {
                const currentVersion = error ? 'unknown' : stdout.trim();
                
                res.status(200).json({
                    success: true,
                    data: {
                        isRunning,
                        currentVersion,
                        lastChecked: new Date().toISOString(),
                        uptime: process.uptime()
                    },
                    timestamp: new Date().toISOString()
                });
            });
        });

    } catch (error) {
        logger.operationError('Update Status', error);
        res.status(500).json({
            success: false,
            error: {
                message: 'Erro interno ao verificar status',
                details: error.message
            }
        });
    }
});

module.exports = router;
'@

$updateRoute | Out-File -FilePath "src/routes/update.js" -Encoding UTF8

# 8. Corrigir JavaScript da interface para atualizar status ap√≥s aplica√ß√£o
Write-Host "üîß Corrigindo JavaScript da interface..." -ForegroundColor Yellow

# Fazer backup do app.js
Copy-Item "src/public/app.js" "src/public/app.js.backup"

# Atualizar fun√ß√£o de aplica√ß√£o de atualiza√ß√µes
$appJsContent = Get-Content "src/public/app.js" -Raw
$appJsContent = $appJsContent -replace 'this\.showToast.*Aplicando atualiza√ß√µes.*success.*', 'this.showToast("‚úÖ Atualiza√ß√µes aplicadas! Verificando status...", "success");`n                // Verificar status ap√≥s aplica√ß√£o`n                setTimeout(() => {`n                    this.checkForUpdates();`n                }, 2000);'
$appJsContent | Out-File -FilePath "src/public/app.js" -Encoding UTF8

# 9. Iniciar DePara
Write-Host "‚ñ∂Ô∏è Iniciando DePara..." -ForegroundColor Yellow
Start-Process -FilePath "npm" -ArgumentList "start" -WindowStyle Hidden
Start-Sleep -Seconds 5

# 10. Verificar se est√° rodando
$nodeProcesses = Get-Process -Name "node" -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*main.js*" }
if ($nodeProcesses) {
    Write-Host "‚úÖ DePara iniciado com sucesso (PID: $($nodeProcesses.Id))" -ForegroundColor Green
} else {
    Write-Host "‚ùå Erro ao iniciar DePara" -ForegroundColor Red
    Write-Host "üí° Tente executar manualmente: npm start" -ForegroundColor Yellow
}

# 11. Testar API de atualiza√ß√µes
Write-Host "üß™ Testando API de atualiza√ß√µes..." -ForegroundColor Yellow
Start-Sleep -Seconds 3

try {
    $response = Invoke-WebRequest -Uri "http://localhost:3000/api/update/status" -UseBasicParsing -TimeoutSec 5
    if ($response.Content -match "success") {
        Write-Host "‚úÖ API de atualiza√ß√µes funcionando" -ForegroundColor Green
    } else {
        Write-Host "‚ùå API de atualiza√ß√µes com problemas" -ForegroundColor Red
    }
} catch {
    Write-Host "‚ùå API de atualiza√ß√µes com problemas" -ForegroundColor Red
}

# 12. Resumo final
Write-Host "üìä Resumo das corre√ß√µes:" -ForegroundColor Blue
Write-Host "‚úÖ Problemas da atualiza√ß√£o autom√°tica corrigidos" -ForegroundColor Green
Write-Host "‚úÖ Verifica√ß√£o de status melhorada" -ForegroundColor Green
Write-Host "‚úÖ Sequ√™ncia de reinicializa√ß√£o corrigida" -ForegroundColor Green
Write-Host "‚úÖ Compatibilidade Windows/Linux implementada" -ForegroundColor Green
Write-Host "üåê Acesse: http://localhost:3000" -ForegroundColor Blue
Write-Host "üîß Para testar: V√° para Configura√ß√µes > Atualiza√ß√µes" -ForegroundColor Blue

Write-Host "üéâ Corre√ß√µes aplicadas com sucesso!" -ForegroundColor Green
